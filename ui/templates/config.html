<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Configuration</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container mt-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">System Configuration</li>
            </ol>
        </nav>
        
        <h1 class="mb-4">System Configuration</h1>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-gear-fill"></i> LLM Integration Settings
                    </div>
                    <div class="card-body">
                        <form id="llm-config-form">
                            <div class="mb-3">
                                <h5 class="border-bottom pb-2">OpenAI Integration</h5>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable-openai" checked>
                                    <label class="form-check-label" for="enable-openai">Enable OpenAI Integration</label>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="openai-api-key" class="form-label">OpenAI API Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="openai-api-key" placeholder="sk-...">
                                        <button class="btn btn-outline-secondary" type="button" id="toggle-api-key">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Your OpenAI API key will be stored securely.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="assistant-ids" class="form-label">OpenAI Assistant IDs</label>
                                    <textarea class="form-control" id="assistant-ids" rows="3" placeholder="Enter one Assistant ID per line"></textarea>
                                    <div class="form-text">Enter each Assistant ID on a new line. These will be used for specialized RAG applications.</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h5 class="border-bottom pb-2">Model Settings</h5>
                                <div class="mb-3">
                                    <label for="default-model" class="form-label">Default Model</label>
                                    <select class="form-select" id="default-model">
                                        <option value="gpt-4">GPT-4 (OpenAI)</option>
                                        <option value="gpt-3.5-turbo" selected>GPT-3.5 Turbo (OpenAI)</option>
                                        <option value="ollama-llama3">Llama 3 (Ollama)</option>
                                        <option value="ollama-mistral">Mistral (Ollama)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label d-block">Available LLM Providers</label>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="provider-openai" checked>
                                        <label class="form-check-label" for="provider-openai">OpenAI</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="provider-ollama" checked>
                                        <label class="form-check-label" for="provider-ollama">Ollama</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">Save Configuration</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-cloud"></i> External Service Integration
                    </div>
                    <div class="card-body">
                        <form id="services-config-form">
                            <div class="mb-3">
                                <h5 class="border-bottom pb-2">Web Search</h5>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable-web-search" checked>
                                    <label class="form-check-label" for="enable-web-search">Enable Web Search</label>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="serper-api-key" class="form-label">Serper API Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="serper-api-key" placeholder="Your Serper API key">
                                        <button class="btn btn-outline-secondary" type="button" id="toggle-serper-key">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">API key for Serper.dev web search service.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="web-search-limit" class="form-label">Max Web Results</label>
                                    <input type="number" class="form-control" id="web-search-limit" min="1" max="10" value="5">
                                    <div class="form-text">Maximum number of web search results to return.</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h5 class="border-bottom pb-2">Elasticsearch</h5>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable-elasticsearch" checked>
                                    <label class="form-check-label" for="enable-elasticsearch">Enable Elasticsearch</label>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="elasticsearch-url" class="form-label">Elasticsearch URL</label>
                                    <input type="text" class="form-control" id="elasticsearch-url" value="http://elasticsearch:9200">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="elasticsearch-index" class="form-label">Index Name</label>
                                    <input type="text" class="form-control" id="elasticsearch-index" value="rag-documents">
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success">Save Service Configuration</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-activity"></i> System Status
                    </div>
                    <div class="card-body">
                        <div id="config-status">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border text-info" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <a href="/systeminfo" class="btn btn-outline-info">
                                <i class="bi bi-info-circle"></i> View Detailed System Info
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/openai.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elements
            const configStatus = document.getElementById('config-status');
            const toggleApiKeyBtn = document.getElementById('toggle-api-key');
            const openaiApiKey = document.getElementById('openai-api-key');
            const toggleSerperKeyBtn = document.getElementById('toggle-serper-key');
            const serperApiKey = document.getElementById('serper-api-key');
            
            // Toggle password visibility
            toggleApiKeyBtn.addEventListener('click', () => {
                if (openaiApiKey.type === 'password') {
                    openaiApiKey.type = 'text';
                    toggleApiKeyBtn.innerHTML = '<i class="bi bi-eye-slash"></i>';
                } else {
                    openaiApiKey.type = 'password';
                    toggleApiKeyBtn.innerHTML = '<i class="bi bi-eye"></i>';
                }
            });
            
            toggleSerperKeyBtn.addEventListener('click', () => {
                if (serperApiKey.type === 'password') {
                    serperApiKey.type = 'text';
                    toggleSerperKeyBtn.innerHTML = '<i class="bi bi-eye-slash"></i>';
                } else {
                    serperApiKey.type = 'password';
                    toggleSerperKeyBtn.innerHTML = '<i class="bi bi-eye"></i>';
                }
            });
            
            // Load configuration status
            async function loadConfigStatus() {
                try {
                    const response = await fetch('/api/health');
                    const data = await response.json();
                    
                    if (!data.api) {
                        configStatus.innerHTML = `<div class="alert alert-danger">Cannot connect to API</div>`;
                        return;
                    }
                    
                    let html = `<div class="list-group">`;
                    
                    // API Status
                    const apiStatus = data.api.api === 'healthy' ? 'success' : 'danger';
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            API Service
                            <span class="badge bg-${apiStatus} rounded-pill">${data.api.api}</span>
                        </div>
                    `;
                    
                    // ChromaDB Status
                    const chromaStatus = data.api.chroma === 'healthy' ? 'success' : 'danger';
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            ChromaDB
                            <span class="badge bg-${chromaStatus} rounded-pill">${data.api.chroma}</span>
                        </div>
                    `;
                    
                    // Elasticsearch Status
                    if (data.api.elasticsearch) {
                        const esStatus = data.api.elasticsearch.includes('healthy') ? 'success' : 
                                      (data.api.elasticsearch === 'disabled' ? 'secondary' : 'danger');
                        html += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                Elasticsearch
                                <span class="badge bg-${esStatus} rounded-pill">${data.api.elasticsearch}</span>
                            </div>
                        `;
                    }
                    
                    // Ollama Status
                    const ollamaStatus = data.api.ollama === 'healthy' ? 'success' : 'danger';
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Ollama
                            <span class="badge bg-${ollamaStatus} rounded-pill">${data.api.ollama}</span>
                        </div>
                    `;
                    
                    // OpenAI Status - need to implement this in the API health check
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            OpenAI
                            <span class="badge bg-secondary rounded-pill">Unconfigured</span>
                        </div>
                    `;
                    
                    html += `</div>`;
                    configStatus.innerHTML = html;
                } catch (error) {
                    configStatus.innerHTML = `<div class="alert alert-danger">Error loading status: ${error.message}</div>`;
                }
            }
            
            // Load current settings from API
            async function loadCurrentSettings() {
                try {
                    const settings = await API.getSettings();
                    
                    if (settings.status === 'success' && settings.settings) {
                        const settingsData = settings.settings;
                        
                        // Update form fields based on current settings
                        document.getElementById('enable-openai').checked = settingsData.has_openai_key;
                        
                        // Set assistant IDs
                        if (settingsData.openai_assistant_ids && settingsData.openai_assistant_ids.length > 0) {
                            document.getElementById('assistant-ids').value = settingsData.openai_assistant_ids.join('\n');
                        }
                        
                        // Set web search settings
                        document.getElementById('enable-web-search').checked = settingsData.has_serper_key;
                        document.getElementById('web-search-limit').value = settingsData.web_results_count || 5;
                        
                        // Set elasticsearch settings
                        document.getElementById('enable-elasticsearch').checked = settingsData.elasticsearch_enabled;
                        document.getElementById('elasticsearch-url').value = settingsData.elasticsearch_url || 'http://elasticsearch:9200';
                        document.getElementById('elasticsearch-index').value = settingsData.elasticsearch_index || 'rag-documents';
                        
                        // Update OpenAI status in the status panel when we reload the status
                        // The jQuery-like :contains selector isn't supported in standard DOM queries
                        const listItems = document.querySelectorAll('.list-group-item');
                        listItems.forEach(item => {
                            if (item.textContent.includes('OpenAI')) {
                                const badge = item.querySelector('.badge');
                                if (badge) {
                                    badge.className = `badge bg-${settingsData.has_openai_key ? 'success' : 'secondary'} rounded-pill`;
                                    badge.textContent = settingsData.has_openai_key ? 'Configured' : 'Not Configured';
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            }
            
            // Load the config status and current settings
            loadConfigStatus();
            loadCurrentSettings();
            
            // Add event listeners for forms
            document.getElementById('llm-config-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                // Get form values
                const enableOpenAI = document.getElementById('enable-openai').checked;
                const openaiApiKey = document.getElementById('openai-api-key').value;
                const assistantIds = document.getElementById('assistant-ids').value.split('\n').filter(id => id.trim());
                const defaultModel = document.getElementById('default-model').value;
                
                // Show saving alert
                configStatus.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-hourglass-split"></i> Saving LLM configuration...
                    </div>
                `;
                
                try {
                    // Create OpenAI config object using our OpenAI utility
                    const config = {
                        apiKey: enableOpenAI ? openaiApiKey : "", // Empty string to clear the key if disabled
                        assistantIds: assistantIds.length > 0 ? assistantIds : undefined
                    };
                    
                    // If OpenAI is disabled, explicitly set an empty API key
                    if (!enableOpenAI) {
                        config.apiKey = "";
                    }
                    
                    // Update OpenAI config using our OpenAI utility
                    const result = await OpenAI.updateConfig(config);
                    
                    if (result.status === 'success') {
                        configStatus.innerHTML = `
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> LLM configuration saved successfully!
                            </div>
                        `;
                    } else {
                        throw new Error(result.message || 'Unknown error');
                    }
                    
                    // Reload status after 2 seconds
                    setTimeout(() => {
                        loadConfigStatus();
                        loadCurrentSettings();
                    }, 2000);
                } catch (error) {
                    configStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error saving configuration: ${error.message}
                        </div>
                    `;
                }
            });
            
            document.getElementById('services-config-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                // Get form values
                const enableWebSearch = document.getElementById('enable-web-search').checked;
                const serperApiKey = document.getElementById('serper-api-key').value;
                const webSearchLimit = document.getElementById('web-search-limit').value;
                const enableElasticsearch = document.getElementById('enable-elasticsearch').checked;
                const elasticsearchUrl = document.getElementById('elasticsearch-url').value;
                const elasticsearchIndex = document.getElementById('elasticsearch-index').value;
                
                // Show saving alert
                configStatus.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-hourglass-split"></i> Saving service configuration...
                    </div>
                `;
                
                try {
                    // TODO: Send to backend API
                    // This should be implemented with actual API endpoints
                    
                    setTimeout(() => {
                        configStatus.innerHTML = `
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> Service configuration saved successfully!
                            </div>
                        `;
                        
                        // Reload status after 2 seconds
                        setTimeout(loadConfigStatus, 2000);
                    }, 1000);
                } catch (error) {
                    configStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error saving configuration: ${error.message}
                        </div>
                    `;
                }
            });
        });
    </script>
</body>
</html>